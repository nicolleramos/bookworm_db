/* CRIAÇÃO DE UMA LIVRARIA FICTÍCIA BOOKWORM */
CREATE DATABASE BOOKWORM
GO

USE BOOKWORM
GO

BEGIN TRANSACTION;

/* TABELAS */
CREATE TABLE CLIENTE (
COD_CLIENTE INT NOT NULL,
NOME_CLIENTE VARCHAR(50) NOT NULL,
CPF VARCHAR(12) NOT NULL,
CEP_ENDERECO VARCHAR(15) NOT NULL,
TELEFONE VARCHAR(15) NOT NULL,
EMAIL VARCHAR(50) NOT NULL,
TIPO_CLIENTE BIT NOT NULL,
CONSTRAINT PK_CLIENTE PRIMARY KEY(COD_CLIENTE),
CONSTRAINT UK_CLIENTE_CPF UNIQUE(CPF)
)
GO

CREATE TABLE EDITORA (
COD_EDITORA INT NOT NULL,
NOME_EDITORA VARCHAR(50) NOT NULL,
TELEFONE VARCHAR(15) NOT NULL,
LOGRADOURO_ENDERECO VARCHAR(75),
NUM_ENDERECO INT,
CEP_ENDERECO CHAR(8),
EMAIL VARCHAR(50) NOT NULL,
CONSTRAINT PK_EDITORA PRIMARY KEY(COD_EDITORA)
)
GO

/* TABELAS COM DEPENDÊNCIAS PRÉVIAS */
CREATE TABLE LIVRO (
ISBN INT NOT NULL,
COD_EDITORA INT NOT NULL,
TITULO VARCHAR(100) NOT NULL,
AUTOR VARCHAR(50) NOT NULL,
GENERO VARCHAR(50) NOT NULL,
ANO_PUBLICACAO INT NOT NULL,
CAPA_DURA BIT,
SINOPSE VARCHAR(MAX),
PRECO_CUSTO SMALLMONEY NOT NULL,
CONSTRAINT PK_LIVRO PRIMARY KEY(ISBN),
CONSTRAINT FK_EDITORA FOREIGN KEY(COD_EDITORA) 
REFERENCES EDITORA(COD_EDITORA)
)
GO

CREATE TABLE ESTOQUE_LIVRO (
ID_ESTOQUE INT PRIMARY KEY NOT NULL,
ISBN INT NOT NULL,
QTDE_ESTOQUE INT NOT NULL,
CONSTRAINT FK_LIVRO FOREIGN KEY(ISBN) 
REFERENCES LIVRO(ISBN)
)
GO

CREATE TABLE PEDIDO (
NF INT NOT NULL,
COD_CLIENTE INT NOT NULL,
DATA_EMISSAO DATE NOT NULL,
CONSTRAINT PK_PEDIDO PRIMARY KEY(NF),
CONSTRAINT FK_PEDIDO_CLIENTE FOREIGN KEY(COD_CLIENTE) 
REFERENCES CLIENTE(COD_CLIENTE)
)
GO

CREATE TABLE ITEM_PEDIDO (
COD_ITEM_PEDIDO INT NOT NULL,
NF_PEDIDO INT NOT NULL,
ISBN_LIVRO INT NOT NULL,
QTDE_ITENS INT NOT NULL,
PRECO_ITEM SMALLMONEY NOT NULL,
CONSTRAINT PK_ITEM_PEDIDO PRIMARY KEY(COD_ITEM_PEDIDO),
CONSTRAINT FK_ITEM_PEDIDO_PEDIDO FOREIGN KEY(NF_PEDIDO)
REFERENCES PEDIDO(NF),
CONSTRAINT FK_ITEM_PEDIDO_LIVRO FOREIGN KEY(ISBN_LIVRO)
REFERENCES LIVRO(ISBN)
)
GO

INSERT INTO CLIENTE 
VALUES 
(1, 'CHRIS', '9622187', '90', '56215763', 'CHRISCB97@GMAIL.COM', 1),
(2, 'ALISON', '7876598', '55', '969875546', 'ALISON@GMAIL.COM', 0),
(3,'CASSIO', '5647768', '88', '19101912', 'CASSIO1910@GMAIL.COM', 0),
(4, 'BRUNA', '4541088', '105', '41414242', 'BRUNA22@GMAIL.COM', 1),
(5, 'FERNANDO', '1254527', '405', '27884565', 'FERNANDO26@GMAIL.COM',1 ),
(6, 'LUANA', '6567657', '402', '45658565', 'LUANA19990@GMAIL.COM', 1),
(7, 'ANA VIVIAN', '7878659', '54', '55658788', 'ANAVIVIAN@GMAIL.COM', 0),
(8, 'GERALD', '9897897', '78', '41414242', 'GERALD1208@GMAIL.COM', 0),
(9, 'MONICA', '9366685', '63', '57689366', 'MONICA1970@GMAIL.COM', 1),
(10, 'ANA LUISA', '1102208', '93', '97886554', 'ANALUISA17@GMAIL.COM',0 ),
(11, 'JEREMY', '4478646', '890', '92245655', 'JEREMY@GMAIL.COM', 1),
(12, 'MELISSA', '20210828', '240', '78775569', 'MELISSA2006@GMAIL.COM', 1),
(13, 'LUCCAS', '5606603', '30', '3600568', 'LUCCAS@GMAIL.COM', 1),
(14, 'JARED', '8987687', '70', '17910155', 'JARED1964@GMAIL.COM', 0),
(15, 'JACOB', '78745459', '92', '86889599', 'JACOB01@GMAIL.COM', 0),
(16, 'LIVIA', '70788674', '69', '46477373', 'LIVIA702@GMAIL.COM', 0);

INSERT INTO EDITORA(COD_EDITORA, NOME_EDITORA, TELEFONE, EMAIL)
VALUES 
(1, 'EDITORA ALEPH', '1807-6211', 'ALEPH.CADASTRO@GMAIL.COM'),
(2, 'PÉ DA LETRA', '6586-1127', 'PEDALETRA.CADASTRO@GMAIL.COM'),
(3, 'ROCCO', '3729-0244', 'ROCCO.CADASTRO@GMAIL.COM'),
(4, 'COMPANHIA DAS LETRAS', '3707-3500', 'COMPANHIALETRAS.CADASTRO@GMAIL.COM');

INSERT INTO LIVRO(ISBN, COD_EDITORA, TITULO, AUTOR, GENERO, ANO_PUBLICACAO, CAPA_DURA, PRECO_CUSTO) VALUES
(1, 1, 'LARANJA MECÂNICA', 'ANTHONY BURGESS', 'FICÇÃO', 2012, 1, 129.90),
(2, 2, 'O GATO PRETO', 'EDGAR ALLAN POE', 'FICÇÃO GÓTICA/TERROR', 2020, 0, 18.00),
(3, 2, 'TRONO DE VIDRO', 'SARAH J MASS', 'FICÇÃO', 2013, 1, 250.50),
(4, 3, 'MORRO DOS VENTOS UIVANTES', 'EMILY BRONTE', 'ROMANCE', 1847, 0, 78.98),
(5, 4, 'O ALQUIMISTA', 'PAULO COELHO', 'ROMANCE', 1988, 0, 30.90),
(6, 2, 'OS SETE MARIDOS DE EVELYN HUGO', 'Taylor Jenkins Reid', 'ROMANCE', 2017, 1, 199.49),
(7, 1, 'FRANKENSTEIN', 'MARY SHELLEY', 'FICÇÃO CIENTIFICA', 1818, 1, 54.22),
(8, 1, 'HARRY POTTER', 'JK ROWLING', '', 1997, 1, 43.69),
(9, 3, 'ORGULHO E PRECONCEITO', 'JANE AUSTEN', 'ROMANCE', 1817, 0, 71.90),
(10, 2, 'ALICE NO PAIS DAS MARAVILHAS', 'LEWIS CARROLL', 'INFANTIL', 1865, 1, 55.17),
(11, 1, 'OS MISERAVEIS', 'VICTOR HUGO', 'ROMANCE', 1862, 1, 127.92),
(12, 4, 'O PEQUENO PRINCIPE', 'ANTOINE DE SAINT-EXUPÉRY', 'INFANTIL', 1943, 0, 46.12),
(13, 4, 'DRACULA', 'BRAM STOKER', 'ROMANCE', 1897, 1, 69.90),
(14, 3, 'UM CONTO DE NATAL', 'CHARLES DICKENS', 'FICÇÃO', 1843, 0, 69.90),
(15, 2, 'O HOMEM DE GIZ', 'C J TUDOR', 'POLICIAL', 2018, 1, 69.90),
(16, 2, 'O PEREGRINO', 'JHON BUNYAN', 'FICÇÃO', 1678, 0, 21.60),
(17, 2, 'A CABANA', 'WILLIAM P YOUNG', 'FICÇÃO', 2007, 0, 43.01),
(18, 1, 'CREPUSCULO', 'STEPHENIE MEYER', 'ROMANCE', 2005, 0, 55.92),
(19, 1, 'DIARIO DE UM BANANA', 'JEFF KINNEY', 'INFANTIL', 2007, 1, 46.12),
(20, 4, 'BETHANIA E A FERA', 'JACK MEGGITT-PHILLIPS', 'INFANTIL', 2021, 1, 39.92),
(21, 3, 'É ASSIM QUE ACABA', 'COLLEEN HOOVER', 'ROMANCE', 2023, 0, 69.90),
(22, 4, 'PERCY JACKSON & THE OLYMPIANS', 'RICK RIORDAN', 'MITOLOGIA GREGA/FICÇÃO', 2007, 1, 44.90),
(23, 1, 'BLADE RUNNER', 'PHILIP K. DICK', 'FICÇÃO CIENTÍFICA', 1990, 0, 53.67);
GO

INSERT INTO ESTOQUE_LIVRO VALUES 
(1, 1, 10),
(2, 2, 10),
(3, 3, 10),
(4, 4, 10),
(5, 5, 10),
(6, 6, 10),
(7, 7, 10),
(8, 8, 10),
(9, 9, 10),
(10, 10, 10),
(11, 11, 10),
(12, 12, 10),
(13, 13, 10),
(14, 14, 10),
(15, 15, 10),
(16, 16, 10),
(17, 17, 10),
(18, 18, 10),
(19, 19, 10),
(20, 20, 10),
(21, 21, 10),
(22, 22, 10),
(23, 23, 10);
GO

INSERT INTO PEDIDO VALUES 
(1, 1, GETDATE()),
(2, 2, GETDATE()),
(3, 3, GETDATE()),
(4, 4, GETDATE()),
(5, 5, GETDATE()),
(6, 6, GETDATE()),
(7, 7, GETDATE()),
(8, 8, GETDATE()),
(9, 9, GETDATE()),
(10, 10, GETDATE()),
(11, 11, GETDATE()),
(12, 12, GETDATE());
GO

INSERT INTO ITEM_PEDIDO VALUES 
(2, 1, 1, 3, 129.90),
(11, 3, 13, 1, 69.90),
(4, 3, 10, 2, 127.92),
(5, 4, 3, 1, 78.98),
(6, 5, 15, 5, 21.60),
(7, 6, 20, 3, 60.90),
(8, 7, 8, 3, 71.90),
(9, 8, 14, 4, 69.90 ),
(12, 11, 4, 1, 30.90);
GO

CREATE TRIGGER INSERIR_NOVO_LIVRO
ON LIVRO

FOR INSERT 
AS
IF (SELECT COUNT(*) FROM INSERTED) = 1
	PRINT 'NOVO LIVRO CADASTRADO COM SUCESSO!'
GO

GO 
CREATE TRIGGER ATUALIZAR_ESTOQUE
ON ITEM_PEDIDO

AFTER INSERT
AS
BEGIN
	DECLARE @ISBN INT,
			@QTDE_ITENS INT

	SELECT @ISBN = ISBN_LIVRO,
		   @QTDE_ITENS = QTDE_ITENS
	FROM INSERTED

	UPDATE ESTOQUE_LIVRO
	SET QTDE_ESTOQUE = QTDE_ESTOQUE - @QTDE_ITENS
	WHERE ISBN = @ISBN
END 

/* LIVROS EM ESTOQUE */
SELECT LIVRO.ISBN, LIVRO.TITULO, ESTOQUE_LIVRO.QTDE_ESTOQUE
FROM LIVRO
INNER JOIN ESTOQUE_LIVRO
ON LIVRO.ISBN = ESTOQUE_LIVRO.ISBN;
GO

CREATE VIEW CLIENTE_FÍSICO AS
SELECT * FROM CLIENTE
WHERE TIPO_CLIENTE = 1
GO

CREATE VIEW CLIENTE_JÚRIDICO AS
SELECT * FROM CLIENTE
WHERE TIPO_CLIENTE = 0
GO

/* CTE SIMPLES */
WITH LIVRO_CATEGORIA (TITULO, AUTOR,GENERO)
AS
(
	SELECT 'O GATO PRETO', 'EDGAR ALLAN POE', 'FICÇÃO GÓTICA/TERROR' 
)
SELECT * FROM LIVRO_CATEGORIA;

SELECT * FROM CLIENTE_FÍSICO
SELECT * FROM CLIENTE_JÚRIDICO
SELECT * FROM LIVRO
SELECT * FROM EDITORA
SELECT * FROM ESTOQUE_LIVRO
SELECT * FROM PEDIDO
SELECT * FROM ITEM_PEDIDO

COMMIT TRANSACTION;
