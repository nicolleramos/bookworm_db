CREATE DATABASE LIVRARIA
GO

USE LIVRARIA
GO

BEGIN TRANSACTION;

CREATE TABLE CLIENTE (
    COD_CLIENTE INT IDENTITY(1,1) PRIMARY KEY,
    NOME_CLIENTE VARCHAR(100) NOT NULL,
    CPF VARCHAR(14) NOT NULL CHECK (CPF LIKE '[0-9][0-9][0-9].[0-9][0-9][0-9].[0-9][0-9][0-9]-[0-9][0-9]'),
    CEP_ENDERECO VARCHAR(9) NOT NULL CHECK (CEP_ENDERECO LIKE '[0-9][0-9][0-9][0-9][0-9]-[0-9][0-9][0-9]'),
    TELEFONE VARCHAR(15) NOT NULL,
    EMAIL VARCHAR(100) NOT NULL CHECK (EMAIL LIKE '%@%.%'),
    TIPO_CLIENTE CHAR(1) NOT NULL CHECK (TIPO_CLIENTE IN ('F', 'J')),
    DATA_CADASTRO DATETIME DEFAULT GETDATE(),
    ATIVO BIT DEFAULT 1,
    CONSTRAINT UK_CLIENTE_CPF UNIQUE(CPF),
    CONSTRAINT UK_CLIENTE_EMAIL UNIQUE(EMAIL)
)
GO

CREATE TABLE EDITORA (
    COD_EDITORA INT IDENTITY(1,1) PRIMARY KEY,
    NOME_EDITORA VARCHAR(100) NOT NULL,
    TELEFONE VARCHAR(15) NOT NULL,
    LOGRADOURO_ENDERECO VARCHAR(100),
    NUM_ENDERECO VARCHAR(10),
    COMPLEMENTO_ENDERECO VARCHAR(50),
    BAIRRO_ENDERECO VARCHAR(50),
    CIDADE_ENDERECO VARCHAR(50),
    UF_ENDERECO CHAR(2),
    CEP_ENDERECO VARCHAR(9) CHECK (CEP_ENDERECO LIKE '[0-9][0-9][0-9][0-9][0-9]-[0-9][0-9][0-9]'),
    EMAIL VARCHAR(100) NOT NULL CHECK (EMAIL LIKE '%@%.%'),
    SITE VARCHAR(100),
    DATA_CADASTRO DATETIME DEFAULT GETDATE()
)
GO

CREATE TABLE LIVRO (
    ISBN VARCHAR(13) PRIMARY KEY CHECK (ISBN LIKE '[0-9][0-9][0-9]-[0-9][0-9][0-9]-[0-9][0-9][0-9]-[0-9][0-9][0-9]-[0-9]'),
    COD_EDITORA INT NOT NULL,
    TITULO VARCHAR(100) NOT NULL,
    AUTOR VARCHAR(100) NOT NULL,
    GENERO VARCHAR(50) NOT NULL,
    ANO_PUBLICACAO INT NOT NULL CHECK (ANO_PUBLICACAO > 0 AND ANO_PUBLICACAO <= YEAR(GETDATE())),
    EDICAO INT DEFAULT 1,
    NUM_PAGINAS INT,
    CAPA_DURA BIT DEFAULT 0,
    SINOPSE VARCHAR(MAX),
    PRECO_CUSTO DECIMAL(10,2) NOT NULL CHECK (PRECO_CUSTO > 0),
    PRECO_VENDA DECIMAL(10,2) NOT NULL CHECK (PRECO_VENDA >= PRECO_CUSTO),
    DATA_CADASTRO DATETIME DEFAULT GETDATE(),
    ATIVO BIT DEFAULT 1,
    CONSTRAINT FK_LIVRO_EDITORA FOREIGN KEY(COD_EDITORA) REFERENCES EDITORA(COD_EDITORA)
)
GO

CREATE TABLE ESTOQUE (
    ID_ESTOQUE INT IDENTITY(1,1) PRIMARY KEY,
    ISBN VARCHAR(13) NOT NULL,
    QTDE_ESTOQUE INT NOT NULL DEFAULT 0 CHECK (QTDE_ESTOQUE >= 0),
    QTDE_RESERVADA INT NOT NULL DEFAULT 0 CHECK (QTDE_RESERVADA >= 0),
    DATA_ATUALIZACAO DATETIME DEFAULT GETDATE(),
    CONSTRAINT FK_ESTOQUE_LIVRO FOREIGN KEY(ISBN) REFERENCES LIVRO(ISBN) ON DELETE CASCADE,
    CONSTRAINT UK_ESTOQUE_ISBN UNIQUE(ISBN)
)
GO

CREATE TABLE PEDIDO (
    NF INT IDENTITY(1,1) PRIMARY KEY,
    COD_CLIENTE INT NOT NULL,
    DATA_EMISSAO DATETIME NOT NULL DEFAULT GETDATE(),
    VALOR_TOTAL DECIMAL(10,2) NOT NULL CHECK (VALOR_TOTAL > 0),
    STATUS CHAR(1) NOT NULL DEFAULT 'A' CHECK (STATUS IN ('A', 'P', 'C', 'E', 'F')), -- Aberto, Pago, Cancelado, Enviado, Finalizado
    FORMA_PAGAMENTO VARCHAR(20) CHECK (FORMA_PAGAMENTO IN ('DINHEIRO', 'CARTAO', 'PIX', 'BOLETO')),
    DATA_PAGAMENTO DATETIME,
    CONSTRAINT FK_PEDIDO_CLIENTE FOREIGN KEY(COD_CLIENTE) REFERENCES CLIENTE(COD_CLIENTE)
)
GO

CREATE TABLE ITEM_PEDIDO (
    COD_ITEM_PEDIDO INT IDENTITY(1,1) PRIMARY KEY,
    NF_PEDIDO INT NOT NULL,
    ISBN_LIVRO VARCHAR(13) NOT NULL,
    QTDE_ITENS INT NOT NULL CHECK (QTDE_ITENS > 0),
    PRECO_UNITARIO DECIMAL(10,2) NOT NULL CHECK (PRECO_UNITARIO > 0),
    DESCONTO DECIMAL(10,2) DEFAULT 0 CHECK (DESCONTO >= 0),
    VALOR_TOTAL DECIMAL(10,2) NOT NULL CHECK (VALOR_TOTAL > 0),
    CONSTRAINT FK_ITEM_PEDIDO_PEDIDO FOREIGN KEY(NF_PEDIDO) REFERENCES PEDIDO(NF) ON DELETE CASCADE,
    CONSTRAINT FK_ITEM_PEDIDO_LIVRO FOREIGN KEY(ISBN_LIVRO) REFERENCES LIVRO(ISBN),
    CONSTRAINT CK_DESCONTO_VALIDO CHECK (VALOR_TOTAL = (QTDE_ITENS * PRECO_UNITARIO) - DESCONTO)
)
GO

CREATE TABLE AUTOR (
    COD_AUTOR INT IDENTITY(1,1) PRIMARY KEY,
    NOME_AUTOR VARCHAR(100) NOT NULL,
    DATA_NASCIMENTO DATE,
    NACIONALIDADE VARCHAR(50),
    BIOGRAFIA VARCHAR(MAX),
    SITE VARCHAR(100)
)
GO

CREATE TABLE LIVRO_AUTOR (
    ISBN VARCHAR(13) NOT NULL,
    COD_AUTOR INT NOT NULL,
    ORDEM_AUTOR INT NOT NULL DEFAULT 1,
    PRIMARY KEY (ISBN, COD_AUTOR),
    CONSTRAINT FK_LIVRO_AUTOR_LIVRO FOREIGN KEY(ISBN) REFERENCES LIVRO(ISBN) ON DELETE CASCADE,
    CONSTRAINT FK_LIVRO_AUTOR_AUTOR FOREIGN KEY(COD_AUTOR) REFERENCES AUTOR(COD_AUTOR) ON DELETE CASCADE
)
GO

INSERT INTO EDITORA (NOME_EDITORA, TELEFONE, EMAIL, SITE)
VALUES 
('EDITORA ALEPH', '(11) 1807-6211', 'aleph.cadastro@gmail.com', 'www.editoraaleph.com.br'),
('PÉ DA LETRA', '(11) 6586-1127', 'pedaletra.cadastro@gmail.com', 'www.pedaletra.com.br'),
('ROCCO', '(21) 3729-0244', 'rocco.cadastro@gmail.com', 'www.rocco.com.br'),
('COMPANHIA DAS LETRAS', '(11) 3707-3500', 'companhialetras.cadastro@gmail.com', 'www.companhiadasletras.com.br');
GO

INSERT INTO AUTOR (NOME_AUTOR, DATA_NASCIMENTO, NACIONALIDADE)
VALUES
('ANTHONY BURGESS', '1917-02-25', 'Britânico'),
('EDGAR ALLAN POE', '1809-01-19', 'Americano'),
('SARAH J. MAAS', '1986-03-05', 'Americana'),
('EMILY BRONTE', '1818-07-30', 'Britânica'),
('PAULO COELHO', '1947-08-24', 'Brasileiro'),
('Taylor Jenkins Reid', NULL, 'Americana'),
('MARY SHELLEY', '1797-08-30', 'Britânica'),
('J.K. ROWLING', '1965-07-31', 'Britânica'),
('JANE AUSTEN', '1775-12-16', 'Britânica'),
('LEWIS CARROLL', '1832-01-27', 'Britânico'),
('VICTOR HUGO', '1802-02-26', 'Francês'),
('ANTOINE DE SAINT-EXUPÉRY', '1900-06-29', 'Francês'),
('BRAM STOKER', '1847-11-08', 'Irlandês'),
('CHARLES DICKENS', '1812-02-07', 'Britânico'),
('C.J. TUDOR', NULL, 'Britânica'),
('JOHN BUNYAN', '1628-11-28', 'Britânico'),
('WILLIAM P. YOUNG', '1955-05-11', 'Canadense'),
('STEPHENIE MEYER', '1973-12-24', 'Americana'),
('JEFF KINNEY', '1971-02-19', 'Americano'),
('JACK MEGGITT-PHILLIPS', NULL, 'Britânico'),
('COLLEEN HOOVER', '1979-12-11', 'Americana'),
('RICK RIORDAN', '1964-06-05', 'Americano'),
('PHILIP K. DICK', '1928-12-16', 'Americano');
GO

INSERT INTO LIVRO (ISBN, COD_EDITORA, TITULO, GENERO, ANO_PUBLICACAO, CAPA_DURA, PRECO_CUSTO, PRECO_VENDA, NUM_PAGINAS, EDICAO)
VALUES
('978-853-590-632-5', 1, 'LARANJA MECÂNICA', 'FICÇÃO', 2012, 1, 129.90, 179.90, 192, 1),
('978-853-781-032-6', 2, 'O GATO PRETO', 'FICÇÃO GÓTICA/TERROR', 2020, 0, 18.00, 29.90, 96, 1),
('978-855-534-168-7', 2, 'TRONO DE VIDRO', 'FICÇÃO', 2013, 1, 250.50, 349.90, 392, 1),
('978-853-593-064-1', 3, 'MORRO DOS VENTOS UIVANTES', 'ROMANCE', 1847, 0, 78.98, 99.90, 416, 1),
('978-850-215-509-9', 4, 'O ALQUIMISTA', 'ROMANCE', 1988, 0, 30.90, 49.90, 208, 1),
('978-855-100-542-8', 2, 'OS SETE MARIDOS DE EVELYN HUGO', 'ROMANCE', 2017, 1, 199.49, 279.90, 360, 1),
('978-857-326-622-2', 1, 'FRANKENSTEIN', 'FICÇÃO CIENTÍFICA', 1818, 1, 54.22, 79.90, 280, 1),
('978-853-253-078-3', 1, 'HARRY POTTER E A PEDRA FILOSOFAL', 'FANTASIA', 1997, 1, 43.69, 69.90, 264, 1),
('978-853-593-062-7', 3, 'ORGULHO E PRECONCEITO', 'ROMANCE', 1817, 0, 71.90, 89.90, 424, 1),
('978-853-781-426-3', 2, 'ALICE NO PAÍS DAS MARAVILHAS', 'INFANTIL', 1865, 1, 55.17, 79.90, 128, 1),
('978-852-092-374-1', 1, 'OS MISERÁVEIS', 'ROMANCE', 1862, 1, 127.92, 189.90, 1488, 1),
('978-859-508-151-2', 4, 'O PEQUENO PRÍNCIPE', 'INFANTIL', 1943, 0, 46.12, 59.90, 96, 1),
('978-853-781-426-4', 4, 'DRÁCULA', 'ROMANCE', 1897, 1, 69.90, 99.90, 488, 1),
('978-853-781-426-5', 3, 'UM CONTO DE NATAL', 'FICÇÃO', 1843, 0, 69.90, 89.90, 112, 1),
('978-855-100-301-1', 2, 'O HOMEM DE GIZ', 'POLICIAL', 2018, 1, 69.90, 99.90, 288, 1),
('978-853-781-426-6', 2, 'O PEREGRINO', 'FICÇÃO', 1678, 0, 21.60, 39.90, 240, 1),
('978-857-542-758-4', 2, 'A CABANA', 'FICÇÃO', 2007, 0, 43.01, 69.90, 240, 1),
('978-855-100-142-0', 1, 'CREPÚSCULO', 'ROMANCE', 2005, 0, 55.92, 79.90, 352, 1),
('978-857-683-462-9', 1, 'DIÁRIO DE UM BANANA', 'INFANTIL', 2007, 1, 46.12, 69.90, 224, 1),
('978-855-100-742-2', 4, 'BETHANIA E A FERA', 'INFANTIL', 2021, 1, 39.92, 59.90, 160, 1),
('978-850-111-052-5', 3, 'É ASSIM QUE ACABA', 'ROMANCE', 2023, 0, 69.90, 99.90, 368, 1),
('978-858-057-224-7', 4, 'PERCY JACKSON E O LADRÃO DE RAIOS', 'MITOLOGIA GREGA/FICÇÃO', 2007, 1, 44.90, 69.90, 400, 1),
('978-853-591-194-6', 1, 'BLADE RUNNER', 'FICÇÃO CIENTÍFICA', 1990, 0, 53.67, 79.90, 288, 1);
GO

INSERT INTO LIVRO_AUTOR (ISBN, COD_AUTOR, ORDEM_AUTOR)
VALUES
('978-853-590-632-5', 1, 1),
('978-853-781-032-6', 2, 1),
('978-855-534-168-7', 3, 1),
('978-853-593-064-1', 4, 1),
('978-850-215-509-9', 5, 1),
('978-855-100-542-8', 6, 1),
('978-857-326-622-2', 7, 1),
('978-853-253-078-3', 8, 1),
('978-853-593-062-7', 9, 1),
('978-853-781-426-3', 10, 1),
('978-852-092-374-1', 11, 1),
('978-859-508-151-2', 12, 1),
('978-853-781-426-4', 13, 1),
('978-853-781-426-5', 14, 1),
('978-855-100-301-1', 15, 1),
('978-853-781-426-6', 16, 1),
('978-857-542-758-4', 17, 1),
('978-855-100-142-0', 18, 1),
('978-857-683-462-9', 19, 1),
('978-855-100-742-2', 20, 1),
('978-850-111-052-5', 21, 1),
('978-858-057-224-7', 22, 1),
('978-853-591-194-6', 23, 1);
GO

UPDATE ESTOQUE 
SET QTDE_ESTOQUE = 10
WHERE ISBN IN (
    SELECT ISBN FROM LIVRO
);
GO

CREATE TRIGGER tr_INSERIR_NOVO_LIVRO
ON LIVRO
AFTER INSERT
AS
BEGIN
    INSERT INTO ESTOQUE (ISBN, QTDE_ESTOQUE)
    SELECT ISBN, 0 FROM inserted
    
    DECLARE @titulo VARCHAR(100)
    SELECT @titulo = TITULO FROM inserted
    
    PRINT 'Novo livro cadastrado com sucesso: ' + @titulo
END
GO

CREATE TRIGGER tr_ATUALIZAR_ESTOQUE
ON ITEM_PEDIDO
AFTER INSERT
AS
BEGIN
    UPDATE E
    SET E.QTDE_ESTOQUE = E.QTDE_ESTOQUE - I.QTDE_ITENS,
        E.DATA_ATUALIZACAO = GETDATE()
    FROM ESTOQUE E
    INNER JOIN inserted I ON E.ISBN = I.ISBN_LIVRO
    
    UPDATE P
    SET P.VALOR_TOTAL = P.VALOR_TOTAL + I.VALOR_TOTAL
    FROM PEDIDO P
    INNER JOIN inserted I ON P.NF = I.NF_PEDIDO
END
GO

CREATE VIEW vw_CLIENTES_FISICOS AS
SELECT 
    COD_CLIENTE,
    NOME_CLIENTE,
    CPF,
    EMAIL,
    TELEFONE,
    DATA_CADASTRO
FROM CLIENTE
WHERE TIPO_CLIENTE = 'F' AND ATIVO = 1
GO

CREATE VIEW vw_CLIENTES_JURIDICOS AS
SELECT 
    COD_CLIENTE,
    NOME_CLIENTE,
    CPF AS CNPJ,
    EMAIL,
    TELEFONE,
    DATA_CADASTRO
FROM CLIENTE
WHERE TIPO_CLIENTE = 'J' AND ATIVO = 1
GO

CREATE VIEW vw_ESTOQUE_DISPONIVEL AS
SELECT 
    L.ISBN,
    L.TITULO,
    E.QTDE_ESTOQUE,
    E.QTDE_RESERVADA,
    (E.QTDE_ESTOQUE - E.QTDE_RESERVADA) AS QTDE_DISPONIVEL,
    L.PRECO_VENDA
FROM LIVRO L
INNER JOIN ESTOQUE E ON L.ISBN = E.ISBN
WHERE L.ATIVO = 1
GO

CREATE PROCEDURE sp_RealizarPedido
    @CodCliente INT,
    @ItensPedido AS dbo.ItensPedidoType READONLY
AS
BEGIN
    BEGIN TRANSACTION
    BEGIN TRY
        DECLARE @NF INT
        DECLARE @ValorTotal DECIMAL(10,2) = 0
        
        SELECT @ValorTotal = SUM(Quantidade * PrecoUnitario)
        FROM @ItensPedido
        
        INSERT INTO PEDIDO (COD_CLIENTE, VALOR_TOTAL)
        VALUES (@CodCliente, @ValorTotal)
        
        SET @NF = SCOPE_IDENTITY()
        
        INSERT INTO ITEM_PEDIDO (NF_PEDIDO, ISBN_LIVRO, QTDE_ITENS, PRECO_UNITARIO, VALOR_TOTAL)
        SELECT 
            @NF,
            ISBN,
            Quantidade,
            PrecoUnitario,
            (Quantidade * PrecoUnitario)
        FROM @ItensPedido
        
        COMMIT TRANSACTION
        RETURN @NF
    END TRY
    BEGIN CATCH
        ROLLBACK TRANSACTION
        THROW
    END CATCH
END
GO

CREATE TYPE dbo.ItensPedidoType AS TABLE
(
    ISBN VARCHAR(13),
    Quantidade INT,
    PrecoUnitario DECIMAL(10,2)
)
GO

COMMIT TRANSACTION;